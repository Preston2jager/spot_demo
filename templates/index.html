
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spot Live Cloud Viewer (Optimized Z-Color)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
        #info { position: absolute; top: 10px; left: 10px; pointer-events: none; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; border: 1px solid #444;}
        .legend { font-size: 12px; margin-top: 10px; line-height: 1.6; }
        .dot { height: 12px; width: 12px; display: inline-block; border-radius: 50%; margin-right: 8px; vertical-align: middle;}
        h3 { margin: 0 0 10px 0; color: #00ff00; font-size: 16px; }
        p { margin: 5px 0; font-size: 13px; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="info">
        <h3>Spot Live Viewer</h3>
        <p>Status: <span id="status" style="color: yellow;">Connecting...</span></p>
        <p>Chunks: <span id="chunkCount">0</span></p>
        <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0;">
        <div class="legend">
            <strong>Height Scale (Z):</strong><br>
            <div><span class="dot" style="background: #ff0000;"></span> > 1.4m (High)</div>
            <div><span class="dot" style="background: #00ff00;"></span> ~ 0.8m (Target)</div>
            <div><span class="dot" style="background: #0000ff;"></span> < 0.2m (Low)</div>
        </div>
        <p style="font-size: 10px; color: #888; margin-top:10px;">* Colors compressed to 0.5m-1.5m range</p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { PLYLoader } from 'three/addons/loaders/PLYLoader.js';

        let camera, scene, renderer, controls;
        const loadedFiles = new Set();
        const loader = new PLYLoader();
        
        // 调整点的大小，如果你觉得点太稀疏，可以调大到 0.05
        const pointMaterial = new THREE.PointsMaterial({ 
            size: 0.025, 
            vertexColors: true 
        });

        init();
        animate();
        
        setInterval(checkForNewFiles, 1000);

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, -8, 6); 
            camera.up.set(0, 0, 1);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0,0,1); // 聚焦在 1.0m 高度附近
            controls.update();

            const gridHelper = new THREE.GridHelper(20, 20, 0x333333, 0x222222);
            gridHelper.rotateX(Math.PI / 2);
            scene.add(gridHelper);
            
            scene.add(new THREE.AxesHelper(1));
            window.addEventListener('resize', onWindowResize);
        }

        async function checkForNewFiles() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                
                let newCount = 0;
                for (const filename of files) {
                    if (!loadedFiles.has(filename)) {
                        loadedFiles.add(filename);
                        loadPlyChunk(filename);
                        newCount++;
                    }
                }
                
                const statusElem = document.getElementById('status');
                if (newCount > 0) {
                    statusElem.textContent = "Syncing...";
                    statusElem.style.color = "#00ff00";
                } else {
                    statusElem.textContent = "Live";
                    statusElem.style.color = "#00ff00";
                }
                document.getElementById('chunkCount').textContent = loadedFiles.size;
            } catch (e) { console.error(e); }
        }

        function loadPlyChunk(filename) {
            loader.load(`/data/${filename}`, (geometry) => {
                const positions = geometry.attributes.position;
                const colors = [];
                const color = new THREE.Color();

                // --- 染色逻辑修改点 ---
                const minZ = -0.5; // 你希望看到蓝色的高度
                const maxZ = 0.5; // 你希望看到红色的高度
                const range = maxZ - minZ;

                for (let i = 0; i < positions.count; i++) {
                    const z = positions.getZ(i);
                    
                    // 归一化：将 z 映射到 0.0 - 1.0 之间
                    let normalizedZ = (z - minZ) / range; 
                    normalizedZ = Math.max(0, Math.min(1, normalizedZ)); // 限制范围
                    
                    // 使用 HSL 染色：0.66(蓝) -> 0.33(绿) -> 0.0(红)
                    const hue = 0.66 * (1.0 - normalizedZ);
                    color.setHSL(hue, 1.0, 0.5);
                    colors.push(color.r, color.g, color.b);
                }

                geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                const points = new THREE.Points(geometry, pointMaterial);
                scene.add(points);
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
